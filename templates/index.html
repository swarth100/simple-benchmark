<!DOCTYPE html>
<html>
<head>
    <title>Benchmark Runner</title>
    <!-- CodeMirror Library -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>

    <!-- HTMx Library -->
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
</head>
<body>

<div class="tabs is-boxed is-medium">
    <ul>
        <li class="is-active"><a onclick="openTab('benchmark-tab', this)">Benchmark Runner</a></li>
        <li><a onclick="openTab('sandbox-tab', this); updateSandboxInputs()">Sandbox Mode</a></li>
        <li><a onclick="openTab('leaderboard-tab', this)">Leaderboards</a></li>
        <li><a onclick="openTab('rankings-tab', this)">Rankings</a></li>

        <!-- Inline username input field -->
        <li class="navbar-item" style="margin-left: auto;">
            <div class="field">
                <p class="control">
                    <input class="input is-info" type="text" placeholder="Username" id="username" name="username">
                </p>
            </div>
        </li>
    </ul>
</div>


<div id="benchmark-tab" class="tab active-tab">
    <form action="/run_benchmark" method="post" id="benchmark-form">
        <div class="field">
            <label class="label" for="benchmark-select">Select Benchmark:</label>
            <div class="control">
                <div class="select">
                    <select name="benchmark" id="benchmark-select">
                        {% for benchmark in benchmarks %}
                        <option value="{{ benchmark }}">{{ benchmark }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <div class="field">
            <label class="label" for="code">Submit Your Code:</label>
            <div class="control">
                <textarea class="textarea" name="code" id="code" rows="10"></textarea>
            </div>
        </div>

        <div class="field is-grouped">
            <p class="control">
                <input type="button" class="button is-warning" value="Reset" id="reset-button" onclick="updateFunctionSignature()">
            </p>
            <p class="control">
                <input type="submit" class="button is-info" value="Run Benchmark" id="submit-button">
            </p>
        </div>

        <!-- The spinner can remain as is, unless you choose to use a Bulma-compatible spinner -->
        <div class="spinner hidden" id="loading-spinner"></div>

        <!-- Hidden field for username -->
        <input type="hidden" name="username" id="form-username">
    </form>
</div>


<div id="sandbox-tab" class="tab">
    <div class="columns">
        <div class="column">
            <form hx-post="/run_sandbox" hx-target="#sandbox-content" hx-trigger="submit">
                <div class="field">
                    <label class="label" for="sandbox-benchmark">Select Benchmark:</label>
                    <div class="control">
                        <div class="select">
                            <select name="benchmark" id="sandbox-benchmark" onchange="updateSandboxInputs()">
                                {% for benchmark in benchmarks %}
                                <option value="{{ benchmark }}">{{ benchmark }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <div class="field">
                    <label class="label" for="sandbox-inputs">Input Parameters (as JSON):</label>
                    <div class="control">
                        <textarea class="textarea" name="sandbox-inputs" id="sandbox-inputs" rows="10"></textarea>
                    </div>
                </div>

                <div class="control">
                    <input type="submit" class="button is-info" value="Run Sandbox">
                </div>
            </form>
        </div>
        <div class="column" id="sandbox-content">
            <!-- Sandbox data will be loaded here -->
        </div>
    </div>
</div>

<div id="leaderboard-tab" class="tab">
    <div class="field">
        <label class="label" for="leaderboard-benchmark">Select Benchmark:</label>
        <div class="control">
            <div class="select">
                <select name="benchmark" id="leaderboard-benchmark" hx-get="/fetch_leaderboard" hx-trigger="change, tab-activated" hx-swap="innerHTML" hx-target="#leaderboard-content" hx-include="#username">
                    {% for benchmark in benchmarks %}
                    <option value="{{ benchmark }}">{{ benchmark }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>
    <div class="mb-4"></div> <!-- Bulma margin bottom class -->
    <div id="leaderboard-content">
        <!-- Leaderboard data will be loaded here -->
    </div>
</div>


<div id="rankings-tab" class="tab">
    <div id="rankings-content" hx-trigger="load, tab-activated" hx-get="/fetch_rankings" hx-swap="innerHTML" hx-include="#username">
        <!-- Rankings data will be loaded here -->
    </div>
</div>

<script>
    // Function to check if the code for a benchmark is empty (after trimming)
    function isCodeEmpty(code) {
        return !code || code.trim() === '';
    }

    function openTab(tabName, element) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tab");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
            tabcontent[i].parentElement.classList.remove("is-active");
        }
        tablinks = document.querySelectorAll(".tabs li");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].classList.remove("is-active");
        }
        document.getElementById(tabName).style.display = "block";
        if (element) {
            element.parentElement.classList.add("is-active");
        }

        // Save the active tab to local storage
        localStorage.setItem('activeTab', tabName);

        // Check if certain tabs are loaded and refresh htmx requests
        if (tabName === 'leaderboard-tab') {
            htmx.trigger('#rankings-content', 'tab-activated');
        } else if (tabName === 'rankings-tab') {
            htmx.trigger('#leaderboard-benchmark', 'tab-activated');
        } else if (tabName === 'benchmark-tab') {
            editor.refresh()
        } else if (tabName === 'sandbox-tab') {
            sandboxEditor.refresh()
        }
    }

    // Function to check if the rankings-tab is active and trigger HTMX call
    function checkAndRefreshRankings() {
        if (localStorage.getItem('activeTab') === "rankings-tab") {
            htmx.trigger('#rankings-content', 'tab-activated');
        }
    }

    // Set interval to refresh rankings every 5 seconds
    setInterval(checkAndRefreshRankings, 5000);

    var editor = CodeMirror.fromTextArea(document.getElementById("code"), {
        lineNumbers: true,
        mode: "python",
        matchBrackets: true,
        indentUnit: 4,
        extraKeys: {
          Tab: (cm) => cm.execCommand("indentMore"),
          "Shift-Tab": (cm) => cm.execCommand("indentLess"),
        },
    });

    // Initialize CodeMirror for JSON editor in Sandbox
    var sandboxEditor = CodeMirror.fromTextArea(document.getElementById("sandbox-inputs"), {
        lineNumbers: false,
        mode: "application/json",
        matchBrackets: true
    });

    document.getElementById('benchmark-form').onsubmit = function() {
        // Add the 'is-loading' class to the submit button
        var submitButton = document.getElementById('submit-button');
        submitButton.classList.add('is-loading');
        document.getElementById('loading-spinner').classList.remove('hidden');

        // Disable the submit button to prevent multiple submissions
        submitButton.disabled = true;

        // Disable the reset button during form submission
        document.getElementById('reset-button').disabled = true;
    };

    // Update the hidden username field in the form whenever the username input changes
    document.getElementById('username').addEventListener('change', function() {
        document.getElementById('form-username').value = this.value;
        localStorage.setItem('username', this.value);
    });

    // Load content from local storage
    function loadContent() {
        // Restore username before all other actions on page
        if (localStorage.getItem('username')) {
            var username = localStorage.getItem('username')
            document.getElementById('form-username').value = username;
            document.getElementById('username').value = username;
        }

        // Restore the active tab
        var activeTab = localStorage.getItem('activeTab') || 'benchmark-tab';
        openTab(activeTab, document.querySelector('.tabs li [onclick*="' + activeTab + '"]'));

        // Restore selected benchmarks
        var benchmarkSelect = localStorage.getItem('selectedBenchmark');
        var sandboxBenchmarkSelect = localStorage.getItem('selectedSandboxBenchmark');
        var leaderboardBenchmarkSelect = localStorage.getItem('selectedLeaderboardBenchmark');

        if (benchmarkSelect) {
            document.getElementById('benchmark-select').value = benchmarkSelect;
            lastSelectedBenchmark = benchmarkSelect;
        } else {
            // If no benchmark is selected we force an update of the benchmark signatures.
            // This guarantees a signature is displayed on initial load.
            updateFunctionSignature();
        }
        if (sandboxBenchmarkSelect) {
            document.getElementById('sandbox-benchmark').value = sandboxBenchmarkSelect;
        }
        if (leaderboardBenchmarkSelect) {
            document.getElementById('leaderboard-benchmark').value = leaderboardBenchmarkSelect;
        }

        var savedData = JSON.parse(localStorage.getItem('editor-by-benchmark') || '{}');
        if (savedData[benchmarkSelect]) {
            editor.setValue(savedData[benchmarkSelect]);
            if (isCodeEmpty(savedData[benchmarkSelect])) {
                updateFunctionSignature();
            }
        } else {
            updateFunctionSignature();
        }

        updateSandboxInputs();
        if (localStorage.getItem('sandbox-inputs')) {
            sandboxEditor.setValue(localStorage.getItem('sandbox-inputs'));
        }

        // IMPORTANT: Must force leaderboard refresh after the username has been set!
        document.getElementById('leaderboard-benchmark').dispatchEvent(new Event('change'));
    }

    var benchmarksWithArgs = {{ benchmarks_with_args | tojson }};
    function updateSandboxInputs() {
        var selectedBenchmark = document.getElementById("sandbox-benchmark").value;
        var defaultArgs = benchmarksWithArgs[selectedBenchmark];
        // Update CodeMirror instance with new value
        var jsonStr = JSON.stringify(defaultArgs, null, 2);

        // Update CodeMirror instance with new value
        sandboxEditor.setValue(jsonStr);
    }

    var benchmarkSignatures = {{ benchmark_signatures | tojson }};
    function updateFunctionSignature() {
        var selectedBenchmark = document.getElementById("benchmark-select").value;
        var signature = benchmarkSignatures[selectedBenchmark];

        // Update CodeMirror instance with new value
        editor.setValue(signature);
    }

    // Save selected benchmarks to local storage
    document.getElementById('benchmark-select').addEventListener('change', function() {
        // Update the lastSelectedBenchmark to the new value
        lastSelectedBenchmark = this.value;
        localStorage.setItem('selectedBenchmark', this.value);

        var savedData = JSON.parse(localStorage.getItem('editor-by-benchmark') || '{}');

        // Load saved code for the selected benchmark or set default signature
        if (savedData[this.value]) {
            editor.setValue(savedData[this.value]);
            if (isCodeEmpty(savedData[this.value])) {
                updateFunctionSignature();
            }
        } else {
            updateFunctionSignature();
        }
    });
    document.getElementById('sandbox-benchmark').addEventListener('change', function() {
        localStorage.setItem('selectedSandboxBenchmark', this.value);
        clearSandboxResult();
    });
    document.getElementById('leaderboard-benchmark').addEventListener('change', function() {
        localStorage.setItem('selectedLeaderboardBenchmark', this.value);
    });

    // Function to save the current state
    var lastSelectedBenchmark = document.getElementById('benchmark-select').value;
    function saveCurrentEditorState() {
        var currentCode = editor.getValue();
        var savedData = JSON.parse(localStorage.getItem('editor-by-benchmark') || '{}');
        savedData[lastSelectedBenchmark] = currentCode;
        localStorage.setItem('editor-by-benchmark', JSON.stringify(savedData));

    }

    function clearSandboxResult() {
        // Clear the content of the 'sandbox-content' div.
        // This prevents stale information from being rendered/shown to the user
        document.getElementById('sandbox-content').innerHTML = '';
    }

    // Attach an event listener to the editor to save the state on change
    editor.on('change', function() {
        saveCurrentEditorState();
    });

      // Attach an event listener to the editor to save the state on change
    sandboxEditor.on('change', function() {
        clearSandboxResult();
    });

    // Save content to local storage
    function saveContent() {
        localStorage.setItem('sandbox-inputs', sandboxEditor.getValue());
    }

    // Event listener for saving content before leaving the page
    window.onbeforeunload = saveContent;

    // Load content when the page loads
    window.onload = function() {
        loadContent();
    };
</script>

</body>
</html>
